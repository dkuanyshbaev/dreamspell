server {
    if ($host = dreamspell.ru) {
        return 301 https://$host$request_uri;
    } # managed by Certbot
    
    listen 80;
    listen [::]:80;
    server_name dreamspell.ru;
    return 404; # managed by Certbot
}

server {
    server_name dreamspell.ru;

    # SSL Configuration - managed by Certbot
    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/dreamspell.ru/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/dreamspell.ru/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Admin panel - routes all /admin/* to dreamadmin service
    location /admin {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-NginX-Proxy true;

        proxy_pass http://127.0.0.1:4444;
        proxy_redirect off;
    }

    # Main application - everything else goes to dreamspell service  
    location / {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-NginX-Proxy true;

        proxy_pass http://127.0.0.1:8888;
        proxy_redirect off;
    }

    # Static files optimization (optional - if you want nginx to serve static files directly)
    # Uncomment if you want nginx to serve static files instead of the app
    # location /static/ {
    #     alias /srv/dreamspell/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }
    # 
    # location /admin/static/ {
    #     alias /srv/dreamadmin/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Client body size limit (for file uploads if needed)
    client_max_body_size 10M;
}